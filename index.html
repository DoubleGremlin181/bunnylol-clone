<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>bunnylol-clone</title>
    <link
      rel="search"
      type="application/opensearchdescription+xml"
      title="bunnylol-clone Search"
      href="/opensearch.xml"
    />
    <link rel="canonical" href="https://bunnylol-clone.kavishhukmani.me" />
    <meta property="og:site_name" content="bunnylol-clone" />
    <link
      rel="icon"
      href="https://raw.githubusercontent.com/DoubleGremlin181/DoubleGremlin181.github.io/refs/heads/master/assets/images/favicon/favicon.ico"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        padding: 20px;
        margin: 0;
      }
      header {
        margin-bottom: 20px;
      }
      .search-bar {
        margin-bottom: 20px;
      }
      .search-bar input {
        padding: 8px;
        font-size: 16px;
        width: 300px;
      }
      .search-bar button {
        padding: 8px 12px;
        font-size: 16px;
      }
      main {
        min-height: 200px;
      }
      table {
        width: 80%;
        margin: 20px auto;
        border-collapse: collapse;
      }
      th,
      td {
        border: 1px solid #333;
        padding: 8px;
        text-align: left;
      }
      th {
        background-color: #f2f2f2;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="search-bar">
        <input
          type="text"
          id="searchBar"
          placeholder="Enter search query..."
          onkeydown="if(event.key==='Enter') submitSearch();"
        />
        <button onclick="submitSearch()">Search</button>
      </div>
    </header>
    <main id="mainContent">
      <h1>Processing...</h1>
    </main>
    <script>
      const isDebug = new URLSearchParams(window.location.search).get("debug") === "true";

      function getDeviceType() {
        const ua = navigator.userAgent;
        if (/Windows NT/i.test(ua)) return "Windows";
        if (/Macintosh|Mac OS X/i.test(ua)) return "MacOS";
        if (/Android/i.test(ua)) return "Android";
        if (/Linux/i.test(ua)) return "Linux";
        if (/iPhone|iPad|iPod/i.test(ua)) return "iOS";
        return "Unknown";
      }

      function parseQuery() {
        return new URLSearchParams(window.location.search).get("q")?.trim() || "";
      }

      function findMatchingRoute(commandConfig, deviceType) {
        // First try to find a route that explicitly supports the device type.
        let route = commandConfig.routes.find(r =>
          Array.isArray(r.supportedDevices) && r.supportedDevices.includes(deviceType)
        );
        // Fallback to a wildcard or "Unknown" support.
        return (
          route ||
          commandConfig.routes.find(
            r =>
              r.supportedDevices === "*" ||
              (Array.isArray(r.supportedDevices) && r.supportedDevices.includes("Unknown"))
          )
        );
      }

      function generateCommandTable() {
        let html = `<h1>Available Commands</h1>
          <table>
            <tr>
              <th>Command</th>
              <th>Supported Devices</th>
              <th>Default URL</th>
              <th>Custom Patterns</th>
              <th>Fallback URL</th>
            </tr>`;
        Object.entries(config.commands).forEach(([cmd, data]) => {
          data.routes.forEach(route => {
            const patterns = route.customPatterns ? route.customPatterns.map(p => p.pattern).join(", ") : "None";
            const devices = Array.isArray(route.supportedDevices) ? route.supportedDevices.join(", ") : "All";
            html += `<tr>
              <td><strong>${cmd}</strong></td>
              <td>${devices}</td>
              <td>${route.defaultUrl}</td>
              <td>${patterns}</td>
              <td>${route.fallbackUrl}</td>
            </tr>`;
          });
        });
        return html + "</table>";
      }

      function showAvailableCommands() {
        document.getElementById("mainContent").innerHTML = generateCommandTable();
      }

      function redirectHelper(url) {
        if (isDebug) {
          console.log("Debug: Delaying redirect to", url);
          setTimeout(() => (window.location.href = url), 3000);
        } else {
          window.location.href = url;
        }
      }

      function processQuery() {
        const query = parseQuery();
        const deviceType = getDeviceType();
        let [rawCommand, ...args] = query ? query.split(" ") : [];

        if (isDebug) {
          console.log("Debug: Device Type:", deviceType);
          console.log("Debug: Command:", rawCommand || "None");
        }

        if (!query) {
          showAvailableCommands();
          return;
        }

        const command = rawCommand.toLowerCase();

        if (!config.commands[command]) {
          const mainContent = document.getElementById("mainContent");
          mainContent.innerHTML = `
            <h1>Command Not Recognized</h1>
            <p>The command "${rawCommand}" is not recognized. Did you mean to google your query?</p>
            <button id="googleButton">Google It</button>
            ${generateCommandTable()}`;
          document.getElementById("googleButton").addEventListener("click", () => {
            const googleCmd = config.commands["g"];
            const url = googleCmd.routes[0].fallbackUrl.replace("{args}", encodeURIComponent(query));
            redirectHelper(url);
          });
          document.addEventListener("keydown", function handler(event) {
            if (event.key.toLowerCase() === "g") {
              const googleCmd = config.commands["g"];
              const url = googleCmd.routes[0].fallbackUrl.replace("{args}", encodeURIComponent(query));
              document.removeEventListener("keydown", handler);
              redirectHelper(url);
            }
          });
          return;
        }

        const commandConfig = config.commands[command];
        const matchingRoute = findMatchingRoute(commandConfig, deviceType);
        if (!matchingRoute) {
          document.getElementById("mainContent").innerHTML = `
            <h1>Unsupported Device</h1>
            <p>No suitable route found for your device.</p>
            ${generateCommandTable()}`;
          return;
        }

        let targetUrl = matchingRoute.defaultUrl;
        if (args.length) {
          const joinedArgs = args.join(" ");
          for (const { pattern, targetUrl: targetPatternUrl } of matchingRoute.customPatterns || []) {
            const regex = new RegExp(`^${pattern.replace(/{(\\w+)}/g, "(?<$1>\\w+)")}$`, "i");
            const match = joinedArgs.match(regex);
            if (match) {
              targetUrl = targetPatternUrl.replace(/{(\w+)}/g, (_, key) => match.groups[key] || "");
              break;
            }
          }
          if (!targetUrl || targetUrl === matchingRoute.defaultUrl) {
            targetUrl = matchingRoute.fallbackUrl.replace("{args}", encodeURIComponent(joinedArgs));
          }
        }
        redirectHelper(targetUrl);
      }

      function submitSearch() {
        const query = document.getElementById("searchBar").value.trim();
        if (query) {
          const redirectUrl = `${window.location.origin}?q=${encodeURIComponent(query)}${
            isDebug ? "&debug=true" : ""
          }`;
          redirectHelper(redirectUrl);
        }
      }

      async function loadConfig() {
        try {
          const response = await fetch("config.json");
          window.config = await response.json();
          processQuery();
        } catch (error) {
          console.error("Error loading config:", error);
        }
      }

      window.addEventListener("load", loadConfig);
    </script>
    <script type="application/ld+json">
      {
        "@context": "http://schema.org",
        "@type": "WebSite",
        "@id": "https://bunnylol-clone.kavishhukmani.me/#WebSite",
        "name": "bunnylol-clone",
        "description": "Host your own bunnylol clone with GitHub pages",
        "alternateName": ["bunnylol-clone", "bunnylol", "lolbunny", "bunny"],
        "url": "https://bunnylol-clone.kavishhukmani.me/"
      }
    </script>
  </body>
</html>
