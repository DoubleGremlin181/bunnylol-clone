<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>bunnylol-clone</title>
    <link
      rel="search"
      type="application/opensearchdescription+xml"
      title="bunnylol-clone Search"
      href="/opensearch.xml"
    />
    <link rel="canonical" href="https://bunnylol-clone.kavishhukmani.me" />
    <meta property="og:site_name" content="bunnylol-clone" />
    <link
      rel="icon"
      href="https://raw.githubusercontent.com/DoubleGremlin181/DoubleGremlin181.github.io/refs/heads/master/assets/images/favicon/favicon.ico"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        padding: 20px;
      }
      .info {
        margin-top: 20px;
        font-size: 18px;
      }
      table {
        width: 80%;
        margin: auto;
        border-collapse: collapse;
      }
      th,
      td {
        border: 1px solid black;
        padding: 8px;
        text-align: left;
      }
      th {
        background-color: #f2f2f2;
      }
      .search-bar {
        margin-bottom: 20px;
      }
      .search-bar input {
        padding: 8px;
        font-size: 16px;
        width: 300px;
      }
      .search-bar button {
        padding: 8px 12px;
        font-size: 16px;
      }
    </style>
  </head>
  <body>
    <div class="search-bar">
      <input
        type="text"
        id="searchBar"
        placeholder="Enter search query..."
        onkeydown="if(event.key === 'Enter') { submitSearch(); }"
      />
      <button onclick="submitSearch()">Search</button>
    </div>
    <div id="mainContent">
      <h1>Processing...</h1>
    </div>
    <script>
      // Global variable to check if debug mode is enabled.
      const isDebug =
        new URLSearchParams(window.location.search).get("debug") === "true";

      function getDeviceType() {
        const userAgent = navigator.userAgent;
        if (/Windows NT/i.test(userAgent)) return "Windows";
        if (/Macintosh|Mac OS X/i.test(userAgent)) return "MacOS";
        if (/Android/i.test(userAgent)) return "Android";
        if (/Linux/i.test(userAgent)) return "Linux";
        if (/iPhone|iPad|iPod/i.test(userAgent)) return "iOS";
        return "Unknown";
      }

      function parseQueryParam() {
        const params = new URLSearchParams(window.location.search);
        return params.get("q")?.trim() || "";
      }

      function findMatchingRoute(commandConfig, deviceType) {
        let matchingRoute = commandConfig.routes.find((route) =>
          route.supportedDevices.includes(deviceType)
        );
        if (!matchingRoute) {
          matchingRoute = commandConfig.routes.find(
            (route) =>
              route.supportedDevices === "*" ||
              (Array.isArray(route.supportedDevices) &&
                route.supportedDevices.includes("Unknown"))
          );
        }
        return matchingRoute;
      }

      function generateCommandTable() {
        let table =
          "<h1>Available Commands</h1><table><tr><th>Command</th><th>Supported Devices</th><th>Default URL</th><th>Custom Patterns</th><th>Fallback URL</th></tr>";
        for (const [cmd, data] of Object.entries(config.commands)) {
          for (const route of data.routes) {
            let patterns = route.customPatterns
              ? route.customPatterns.map((p) => p.pattern).join(", ")
              : "None";
            let devices = Array.isArray(route.supportedDevices)
              ? route.supportedDevices.join(", ")
              : "All";
            table += `<tr><td><strong>${cmd}</strong></td><td>${devices}</td><td>${route.defaultUrl}</td><td>${patterns}</td><td>${route.fallbackUrl}</td></tr>`;
          }
        }
        table += "</table>";
        return table;
      }

      function showAvailableCommands() {
        document.getElementById("mainContent").innerHTML =
          generateCommandTable();
      }

      function delayedRedirect(url) {
        if (isDebug) {
          console.log(
            "Debug - delaying redirect for 3000ms. Redirecting to: " + url
          );
          setTimeout(() => {
            window.location.href = url;
          }, 3000);
        } else {
          window.location.href = url;
        }
      }

      function processQuery() {
        const query = parseQueryParam();
        const deviceType = getDeviceType();
        let rawCommand = "";
        let args = [];
        if (query) {
          [rawCommand, ...args] = query.split(" ");
        }

        if (isDebug) {
          console.log("Debug - Device Type: " + deviceType);
          if (rawCommand) {
            console.log("Debug - Command: " + rawCommand);
          } else {
            console.log("Debug - No command provided");
          }
        }

        if (!query) {
          showAvailableCommands();
          return;
        }

        // Convert the command to lowercase for case-insensitive matching
        const command = rawCommand.toLowerCase();

        if (!config.commands[command]) {
          document.getElementById("mainContent").innerHTML =
            "<h1>Command Not Recognized</h1>" +
            '<p>The command "' +
            rawCommand +
            '" is not recognized. Did you mean to google your query?</p>' +
            '<button id="googleButton">Google It</button>' +
            generateCommandTable();

          document
            .getElementById("googleButton")
            .addEventListener("click", function () {
              const googleCommand = config.commands["g"];
              const fallbackUrl = googleCommand.routes[0].fallbackUrl.replace(
                "{args}",
                encodeURIComponent(query)
              );
              delayedRedirect(fallbackUrl);
            });

          document.addEventListener("keydown", function handler(event) {
            if (event.key.toLowerCase() === "g") {
              const googleCommand = config.commands["g"];
              const fallbackUrl = googleCommand.routes[0].fallbackUrl.replace(
                "{args}",
                encodeURIComponent(query)
              );
              document.removeEventListener("keydown", handler);
              console.log("Debug - Key 'g' pressed. Initiating redirect.");
              delayedRedirect(fallbackUrl);
            }
          });
          return;
        }

        const commandConfig = config.commands[command];
        const matchingRoute = findMatchingRoute(commandConfig, deviceType);
        if (!matchingRoute) {
          document.getElementById("mainContent").innerHTML =
            "<h1>Unsupported Device</h1><p>No suitable route found for your device.</p>" +
            generateCommandTable();
          return;
        }

        let targetUrl = matchingRoute.defaultUrl;
        if (args.length > 0) {
          for (const patternObj of matchingRoute.customPatterns) {
            const patternRegex = new RegExp(
              `^${patternObj.pattern.replace(/{(\\w+)}/g, "(?<$1>\\w+)")}$`,
              "i"
            );
            const match = args.join(" ").match(patternRegex);
            if (match) {
              targetUrl = patternObj.targetUrl.replace(
                /{(\w+)}/g,
                (_, key) => match.groups[key] || ""
              );
              break;
            }
          }
          if (!targetUrl || targetUrl === matchingRoute.defaultUrl) {
            targetUrl = matchingRoute.fallbackUrl.replace(
              "{args}",
              encodeURIComponent(args.join(" "))
            );
          }
        }
        delayedRedirect(targetUrl);
      }

      function submitSearch() {
        const searchInput = document.getElementById("searchBar");
        if (searchInput) {
          const query = searchInput.value.trim();
          if (query) {
            if (isDebug) {
              console.log("Debug - Search bar used: " + query);
            }
            // Preserve debug mode for the new search if it's enabled.
            const redirectUrl =
              window.location.origin +
              "?q=" +
              encodeURIComponent(query) +
              (isDebug ? "&debug=true" : "");
            delayedRedirect(redirectUrl);
          }
        }
      }

      // Asynchronously load the configuration from config.json and then process the query.
      async function loadConfig() {
        try {
          const response = await fetch("config.json");
          window.config = await response.json();
          processQuery();
        } catch (error) {
          console.error("Error loading config:", error);
        }
      }

      window.onload = loadConfig;
    </script>
    <script type="application/ld+json">
      {
        "@context": "http://schema.org",
        "@type": "WebSite",
        "@id": "https://bunnylol-clone.kavishhukmani.me/#WebSite",
        "name": "bunnylol-clone",
        "description": "Host your own bunnylol clone with GitHub pages",
        "alternateName": ["bunnylol-clone", "bunnylol", "lolbunny", "bunny"],
        "url": "https://bunnylol-clone.kavishhukmani.me/"
      }
    </script>
  </body>
</html>
