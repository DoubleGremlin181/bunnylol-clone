<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bunnylol-clone Functionality Test</title>
    <link rel="search" type="application/opensearchdescription+xml" title="bunnylol-clone Search" href="/opensearch.xml">
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
        .info { margin-top: 20px; font-size: 18px; }
        table { width: 80%; margin: auto; border-collapse: collapse; }
        th, td { border: 1px solid black; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
    <script>
        const config = {
            "commands": {
                "g": {
                    "routes": [
                        {
                            "supportedDevices": "*",
                            "defaultUrl": "https://www.google.com",
                            "customPatterns": [],
                            "fallbackUrl": "https://www.google.com/search?q={args}"
                        }
                    ]
                },
                "yt": {
                    "routes": [
                        {
                            "supportedDevices": "*",
                            "defaultUrl": "https://www.youtube.com",
                            "customPatterns": [
                                {
                                    "pattern": "subs",
                                    "targetUrl": "https://www.youtube.com/feed/subscriptions"
                                },
                                {
                                    "pattern": "c/{channel_name}",
                                    "targetUrl": "https://www.youtube.com/c/{channel_name}"
                                }
                            ],
                            "fallbackUrl": "https://www.youtube.com/results?search_query={args}"
                        }
                    ]
                },
                "maps": {
                    "routes": [
                        {
                            "supportedDevices": ["Android", "iOS"],
                            "defaultUrl": "https://maps.google.com",
                            "customPatterns": [
                                {
                                    "pattern": "directions/{from}/{to}",
                                    "targetUrl": "https://maps.google.com/dir/{from}/{to}"
                                }
                            ],
                            "fallbackUrl": "https://maps.google.com/?q={args}"
                        }
                    ]
                },
                "apps": {
                    "routes": [
                        {
                            "supportedDevices": ["Android"],
                            "defaultUrl": "https://play.google.com/store",
                            "customPatterns": [
                                {
                                    "pattern": "developer/{dev_name}",
                                    "targetUrl": "https://play.google.com/store/apps/developer?id={dev_name}"
                                }
                            ],
                            "fallbackUrl": "https://play.google.com/store/search?q={args}"
                        },
                        {
                            "supportedDevices": ["iOS"],
                            "defaultUrl": "https://apps.apple.com",
                            "customPatterns": [
                                {
                                    "pattern": "developer/{dev_name}",
                                    "targetUrl": "https://apps.apple.com/developer/{dev_name}"
                                }
                            ],
                            "fallbackUrl": "https://apps.apple.com/search?q={args}"
                        },
                        {
                            "supportedDevices": ["MacOS", "Windows", "Linux", "Unknown"],
                            "defaultUrl": "https://store.steampowered.com",
                            "customPatterns": [
                                {
                                    "pattern": "category/{category_name}",
                                    "targetUrl": "https://store.steampowered.com/category/{category_name}"
                                }
                            ],
                            "fallbackUrl": "https://store.steampowered.com/search/?term={args}"
                        }
                    ]
                }
            }
        };

        function getDeviceType() {
            const userAgent = navigator.userAgent;
            if (/Windows NT/i.test(userAgent)) return "Windows";
            if (/Macintosh|Mac OS X/i.test(userAgent)) return "MacOS";
            if (/Linux/i.test(userAgent)) return "Linux";
            if (/Android/i.test(userAgent)) return "Android";
            if (/iPhone|iPad|iPod/i.test(userAgent)) return "iOS";
            return "Unknown";
        }

        function parseQueryParam() {
            const params = new URLSearchParams(window.location.search);
            return params.get("q")?.trim() || "";
        }

        function findMatchingRoute(commandConfig, deviceType) {
            // Prioritize exact device match
            let matchingRoute = commandConfig.routes.find(route => route.supportedDevices.includes(deviceType));

            // If no exact match, check for wildcard ('*')
            if (!matchingRoute) {
                matchingRoute = commandConfig.routes.find(route => route.supportedDevices === "*" || route.supportedDevices.includes("Unknown"));
            }

            return matchingRoute;
        }

        function generateCommandTable() {
            let table = '<h1>Available Commands</h1><table><tr><th>Command</th><th>Supported Devices</th><th>Default URL</th><th>Custom Patterns</th><th>Search URL</th></tr>';
            for (const [cmd, data] of Object.entries(config.commands)) {
                for (const route of data.routes) {
                    let patterns = route.customPatterns.length ? route.customPatterns.map(p => p.pattern).join(', ') : 'None';
                    let devices = Array.isArray(route.supportedDevices) ? route.supportedDevices.join(', ') : "All";
                    table += `<tr><td><strong>${cmd}</strong></td><td>${devices}</td><td>${route.defaultUrl}</td><td>${patterns}</td><td>${route.fallbackUrl}</td></tr>`;
                }
            }
            table += '</table>';
            return table;
        }

        function showAvailableCommands() {
            document.body.innerHTML = generateCommandTable();
        }

        function processQuery() {
            const query = parseQueryParam();
            if (!query) {
                showAvailableCommands();
                return;
            }

            const deviceType = getDeviceType();
            const [command, ...args] = query.split(" ");
            if (!config.commands[command]) {
                document.body.innerHTML = '<h1>Invalid Command</h1><p>The command provided is not recognized.</p>' + generateCommandTable();
                return;
            }

            const commandConfig = config.commands[command];
            const matchingRoute = findMatchingRoute(commandConfig, deviceType);
            if (!matchingRoute) {
                document.body.innerHTML = '<h1>Unsupported Device</h1><p>No suitable route found for your device.</p>' + generateCommandTable();
                return;
            }

            let targetUrl = matchingRoute.defaultUrl;

            if (args.length > 0) {
                for (const patternObj of matchingRoute.customPatterns) {
                    const patternRegex = new RegExp(`^${patternObj.pattern.replace(/{(\w+)}/g, '(?<$1>\\w+)')}$`);
                    const match = args.join(" ").match(patternRegex);
                    if (match) {
                        targetUrl = patternObj.targetUrl.replace(/{(\w+)}/g, (_, key) => match.groups[key] || "");
                        break;
                    }
                }
                if (!targetUrl || targetUrl === matchingRoute.defaultUrl) {
                    targetUrl = matchingRoute.fallbackUrl.replace("{args}", encodeURIComponent(args.join(" ")));
                }
            }
            window.location.href = targetUrl;
        }

        window.onload = processQuery;
    </script>
</head>
<body>
    <h1>Processing...</h1>
</body>
</html>
